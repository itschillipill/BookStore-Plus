name: Flutter Web Docker CI/CD

on:
  push:
    branches: [main]

jobs:
  docker_build_deploy:
    name: Build & Deploy Flutter Web via Docker
    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Клонируем репозиторий
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2️⃣ Настройка Docker Buildx (для multi-stage)
      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v2

      # 3️⃣ Собираем multi-stage образ (Flutter Web → Nginx)
      - name: Build Docker image
        run: docker build -t bookstore_web .

      # 4️⃣ Извлекаем готовый web билд из контейнера
      - name: Extract web build
        run: |
          docker create --name extract bookstore_web
          docker cp extract:/usr/share/nginx/html ./build_web
          docker rm -f extract

      # 5️⃣ Публикуем на GitHub Pages
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.PAGES_DEPLOY_TOKEN }}
          external_repository: itschillipill/itschillipill.github.io
          publish_dir: ./build_web
          destination_dir: BookStore-Plus
          publish_branch: main
